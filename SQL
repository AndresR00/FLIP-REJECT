SELECT *,
CASE
  WHEN SYM_REJECT_REASON = 'CustomerRejected' THEN WM_REJECT_REASON
  ELSE SYM_REJECT_REASON
END REJECT_REASON
FROM (
SELECT
DATE(BUSINESS_DATE) AS DATE,
LPN,
SKU,
REJECT_DATETIME,
--DRIVEWAY,
REJECT_REASON AS SYM_REJECT_REASON,
B.WM_REJECT_REASON
FROM `wmt-edw-sandbox.SYMBOTIC_DATA.snowflake_rejects_raw`
 
LEFT OUTER JOIN(
  SELECT
  --CORRELATION_ID,
  --EQUIPMENT_NAME,
  --HEIGHT,
  --LENGTH,
  --WIDTH,
  --CAMERA_ID,
  --GROUP_NUMBER,
  --ITEM_NUMBER,
  --MATCHED_GTIN_TYPE,
  LPN_ID,
  JSON_VALUE(EVENT.status) EVENT_STATUS,
  CASE
    WHEN JSON_VALUE(EVENT.status) IN ('VERIFIED', 'BYPASS') THEN NULL -- not rejected
    ELSE JSON_VALUE(EVENT.status)
  END WM_REJECT_REASON,
  CASE
    WHEN JSON_VALUE(EVENT.status) IN ('VERIFIED', 'BYPASS') THEN NULL -- not rejected
    WHEN JSON_VALUE(EVENT.status) IN ('FLIB_DIVERT', 'FLIB_INELIGIBLE') THEN 'SYM Rejected'
    ELSE 'Customer Rejected'
  END REJECT_SOURCE
 
  FROM `wmt-edw-prod.US_SUPPLY_CHAIN_SCT_NONCAT_VM.HAWKEYE_BQ_VIEW_INBOUND`
  WHERE EVENT_TYPE = 'LABEL_VERIFICATION'
  AND DC_NUMBER = '06035'
)B
ON LPN = B.LPN_ID
 
WHERE DC = '6035'
AND DRIVEWAY LIKE '%FLIB%'
AND DATE(BUSINESS_DATE) between DATE(2026,1,14) and DATE(2026,1,15)
)






Reject Category


WITH source AS (
  SELECT
    DATE(s.BUSINESS_DATE) AS DATE,
    s.LPN,
    s.SKU,
    s.REJECT_DATETIME,
    -- s.DRIVEWAY,
    s.REJECT_REASON AS SYM_REJECT_REASON,
    b.WM_REJECT_REASON
  FROM `wmt-edw-sandbox.SYMBOTIC_DATA.snowflake_rejects_raw` s

  LEFT OUTER JOIN (
    SELECT
      LPN_ID,
      JSON_VALUE(EVENT.status) AS EVENT_STATUS,
      CASE
        WHEN JSON_VALUE(EVENT.status) IN ('VERIFIED', 'BYPASS') THEN NULL
        ELSE JSON_VALUE(EVENT.status)
      END AS WM_REJECT_REASON,
      CASE
        WHEN JSON_VALUE(EVENT.status) IN ('VERIFIED', 'BYPASS') THEN NULL
        WHEN JSON_VALUE(EVENT.status) IN ('FLIB_DIVERT', 'FLIB_INELIGIBLE') THEN 'SYM Rejected'
        ELSE 'Customer Rejected'
      END AS REJECT_SOURCE
    FROM `wmt-edw-prod.US_SUPPLY_CHAIN_SCT_NONCAT_VM.HAWKEYE_BQ_VIEW_INBOUND`
    WHERE EVENT_TYPE = 'LABEL_VERIFICATION'
      AND DC_NUMBER = '06035'
  ) b
    ON s.LPN = b.LPN_ID

  WHERE s.DC = '6035'
    AND s.DRIVEWAY LIKE '%FLIB%'
    AND DATE(s.BUSINESS_DATE) = DATE '2026-02-11'
),

final AS (
  -- resolve CustomerRejected -> use WM reason, keep original otherwise
  SELECT
    DATE,
    LPN,
    SKU,
    REJECT_DATETIME,
    SYM_REJECT_REASON,
    WM_REJECT_REASON,
    CASE
      WHEN SYM_REJECT_REASON = 'CustomerRejected' THEN WM_REJECT_REASON
      ELSE SYM_REJECT_REASON
    END AS FINAL_REJECT_REASON
  FROM source
)

SELECT
  DATE,
  LPN,
  SKU,
  REJECT_DATETIME,
  SYM_REJECT_REASON,
  WM_REJECT_REASON,
  FINAL_REJECT_REASON,

  -- normalized token for robust matching (uppercase + remove non-alphanumerics)
  REGEXP_REPLACE(UPPER(TRIM(FINAL_REJECT_REASON)), r'[^A-Z0-9]', '') AS FINAL_REJECT_REASON_NORM,

  -- final AREA: any unmatched / NULL -> Palletization Area
  CASE
    -- treat NULL final reason as Palletization Area
    WHEN FINAL_REJECT_REASON IS NULL THEN 'Palletization Area'

    WHEN REGEXP_REPLACE(UPPER(TRIM(FINAL_REJECT_REASON)), r'[^A-Z0-9]', '') IN (
      -- Rework Area (normalized tokens)
      'NOLABELSEENATREJECTSORTER','LABELNOTSEEN','ANGLEERROR','ARROWNOTUP','DAMAGED',
      'DUPLICATECARTONID','HARDWAREREJECTED','NOINDUCTIONMESSAGE','MAXBOTTOMNARROWING',
      'MULTIPLEACTIVEBARCODES','BYPASS','OPENFLAP','OTHER','PROTUBERANCE',
      'THRESHOLDVIOLATION','SYSTEMSTIMEOUT','UNKNOWNSKU','WEIGHTINVALID',
      'UNKNOWNDELIVERYNUMBER','WHPKNOTTAUGHT','HOSTLATE','OVERAGE','MISPULL',
      'INVALIDREQUEST','NOITEMFILEMATCH','SYSTEMERROR','MAXOVERAGELIMIT',
      'NOOVERAGELABEL','UPCNOTFOUND','PROBLEMASN','NODATAASN','AUDIT',
      'NOBARCODESEEN','XBLOCK','NOSCAN','PURGEACTIVE','UNREADABLEUPC',
      'DAMAGEDCASE','TIPPEDCASE','AMBIGUOUSLPNFORUPC','UNKNOWNUPC'
    ) THEN 'Rework Area'

    WHEN REGEXP_REPLACE(UPPER(TRIM(FINAL_REJECT_REASON)), r'[^A-Z0-9]', '') IN (
      -- Palletization Area (normalized tokens)
      'BARCODEMISMATCH','DIMENSIONINVALID','NOTELIGIBLE','NONCONSSTK','LIMITEDITEM',
      'HAZMAT','LITHIUM','BREAKOUT','MASTERPACK','NONCON',
      'SSTK','SSTKATLASITEM','DAATLASITEM','INELIGIBLE',
      'WEIGHTUNDERLIMITS','WEIGHTOVERLIMITS',
      'DIMENSIONSOVERLIMITS','DIMENSIONSUNDERLIMITS',
      'INVALIDASPECTRATIO','LPNREJECTED'
    ) THEN 'Palletization Area'

    -- default: previously Unmapped -> Palletization Area (per your request)
    ELSE 'Palletization Area'
  END AS AREA

FROM final
ORDER BY DATE, REJECT_DATETIME;














Reject Category and FLIB #

WITH source AS (
  SELECT
    DATE(s.BUSINESS_DATE) AS DATE,
    s.DRIVEWAY,
    s.REJECT_REASON AS SYM_REJECT_REASON,
    b.WM_REJECT_REASON
  FROM `wmt-edw-sandbox.SYMBOTIC_DATA.snowflake_rejects_raw` s

  LEFT JOIN (
    SELECT
      LPN_ID,
      CASE
        WHEN JSON_VALUE(EVENT.status) IN ('VERIFIED', 'BYPASS') THEN NULL
        ELSE JSON_VALUE(EVENT.status)
      END AS WM_REJECT_REASON
    FROM `wmt-edw-prod.US_SUPPLY_CHAIN_SCT_NONCAT_VM.HAWKEYE_BQ_VIEW_INBOUND`
    WHERE EVENT_TYPE = 'LABEL_VERIFICATION'
      AND DC_NUMBER = '06035'
  ) b
    ON s.LPN = b.LPN_ID

  WHERE s.DC = '6035'
    AND s.DRIVEWAY LIKE 'FLIB%'
    AND DATE(s.BUSINESS_DATE) >= DATE '2025-01-01'
),

final AS (
  SELECT
    DATE,
    DRIVEWAY,

    CASE
      WHEN SYM_REJECT_REASON = 'CustomerRejected' THEN WM_REJECT_REASON
      ELSE SYM_REJECT_REASON
    END AS FINAL_REJECT_REASON
  FROM source
),

classified AS (
  SELECT
    DATE,

    -- ðŸ”¹ NEW COLUMN 1: FLIB number (219)
    REGEXP_EXTRACT(DRIVEWAY, r'FLIB(\d+)') AS FLIB_NUMBER,

    -- ðŸ”¹ NEW COLUMN 2: Driveway name (DRV1)
    REGEXP_EXTRACT(DRIVEWAY, r'-(.*)$') AS DRIVEWAY_NAME,

    CASE
      WHEN FINAL_REJECT_REASON IS NULL THEN 'Palletization Area'

      WHEN REGEXP_REPLACE(UPPER(TRIM(FINAL_REJECT_REASON)), r'[^A-Z0-9]', '') IN (
        'NOLABELSEENATREJECTSORTER','LABELNOTSEEN','ANGLEERROR','ARROWNOTUP','DAMAGED',
        'DUPLICATECARTONID','HARDWAREREJECTED','NOINDUCTIONMESSAGE','MAXBOTTOMNARROWING',
        'MULTIPLEACTIVEBARCODES','BYPASS','OPENFLAP','OTHER','PROTUBERANCE',
        'THRESHOLDVIOLATION','SYSTEMSTIMEOUT','UNKNOWNSKU','WEIGHTINVALID',
        'UNKNOWNDELIVERYNUMBER','WHPKNOTTAUGHT','HOSTLATE','OVERAGE','MISPULL',
        'INVALIDREQUEST','NOITEMFILEMATCH','SYSTEMERROR','MAXOVERAGELIMIT',
        'NOOVERAGELABEL','UPCNOTFOUND','PROBLEMASN','NODATAASN','AUDIT',
        'NOBARCODESEEN','XBLOCK','NOSCAN','PURGEACTIVE','UNREADABLEUPC',
        'DAMAGEDCASE','TIPPEDCASE','AMBIGUOUSLPNFORUPC','UNKNOWNUPC'
      ) THEN 'Rework Area'

      ELSE 'Palletization Area'
    END AS AREA

  FROM final
)

SELECT
  DATE,
  FLIB_NUMBER,
  DRIVEWAY_NAME,
  AREA,
  COUNT(*) AS REJECT_COUNT
FROM classified
GROUP BY DATE, FLIB_NUMBER, DRIVEWAY_NAME, AREA
ORDER BY DATE, FLIB_NUMBER, AREA;



 
